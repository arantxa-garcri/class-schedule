<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de sesiones por semestre</title>

  <style>
    /* ============================================================
       GU√çA R√ÅPIDA PARA MODIFICAR (sin perderte)
       1) Colores/tema: busca "CONFIG: COLORES Y TEMA"
       2) Layout responsivo: busca "CONFIG: LAYOUT"
       3) Componentes UI: busca "CONFIG: COMPONENTES"
       4) C√°lculo de sesiones: en JS busca "CALCULO DE SESIONES"
       5) Unidades: en JS busca "CALCULO: UNIDADES" y "UI: UNIDADES"
       ============================================================ */

    /* ============================================================
       CONFIG: COLORES Y TEMA
       - Cambia variables aqu√≠ y cambias todo el look.
       ============================================================ */
    :root{
      --teal:  #3F9AAE;
      --aqua:  #79C9C5;
      --cream: #FFE2AF;
      --coral: #F96E5B;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --radius: 18px;
      --radius-sm: 12px;
      --gap: 14px;

      --shadow: 0 18px 50px rgba(0,0,0,0.28);
      --blur: 12px;

      --maxw: 1220px;
      --sidebarW: 360px;

      /* ========== TEMA OSCURO ========== */
      --bg0: #061014;
      --bg1: #0b1b22;

      --text: #EAF4F6;
      --muted: rgba(234,244,246,0.70);

      --glass: rgba(255,255,255,0.07);
      --glass2: rgba(255,255,255,0.10);

      --bd: rgba(255,255,255,0.12);
      --bd2: rgba(255,255,255,0.18);

      --focus: rgba(121,201,197,0.55);

      --btn: rgba(255,255,255,0.06);
      --btnHover: rgba(255,255,255,0.10);

      --primaryBg: rgba(63,154,174,0.20);
      --primaryBd: rgba(63,154,174,0.62);

      --dangerBg: rgba(249,110,91,0.16);
      --dangerBd: rgba(249,110,91,0.62);

      --warnBg: rgba(255,226,175,0.16);
      --warnBd: rgba(255,226,175,0.60);
    }

    /* ========== TEMA CLARO ========== */
    html[data-theme="light"]{
      --bg0: #f5fbfb;
      --bg1: #eef7f7;

      --text: #0f262d;
      --muted: rgba(15,38,45,0.62);

      --glass: rgba(255,255,255,0.86);
      --glass2: rgba(255,255,255,0.68);

      --bd: rgba(15,38,45,0.12);
      --bd2: rgba(15,38,45,0.18);

      --shadow: 0 18px 50px rgba(2,6,23,0.12);
      --focus: rgba(63,154,174,0.33);

      --btn: rgba(255,255,255,0.72);
      --btnHover: rgba(255,255,255,0.88);

      --primaryBg: rgba(63,154,174,0.16);
      --primaryBd: rgba(63,154,174,0.40);

      --dangerBg: rgba(249,110,91,0.12);
      --dangerBd: rgba(249,110,91,0.45);

      --warnBg: rgba(255,226,175,0.22);
      --warnBd: rgba(255,226,175,0.55);
    }

    /* ============================================================
       BASE
       ============================================================ */
    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      overflow-x: hidden;

      background:
        radial-gradient(900px 520px at 12% 0%, rgba(121,201,197,0.18), transparent 60%),
        radial-gradient(900px 520px at 88% 8%, rgba(63,154,174,0.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* ============================================================
       CONFIG: LAYOUT
       ============================================================ */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;

      border-bottom: 1px solid var(--bd);
      background: color-mix(in srgb, var(--bg1) 82%, transparent);
      backdrop-filter: blur(var(--blur));

      padding: 14px 16px;
    }

    .topbarInner{
      max-width: var(--maxw);
      margin: 0 auto;

      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brandTitle{
      display: flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .brandTitle h1{
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .brandTitle .tag{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }

    .brandSub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.3;
    }

    .actionsTop{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    .app{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 16px;

      display: grid;
      grid-template-columns: var(--sidebarW) 1fr;
      gap: var(--gap);
      align-items: start;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    .backdrop{ display: none; }

    .sidebar{
      position: sticky;
      top: 82px;
      align-self: start;
    }

    @media (max-width: 980px){
      .sidebar{
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: min(92vw, 420px);
        transform: translateX(-110%);
        transition: transform 220ms ease;

        z-index: 60;
        overflow: auto;
        padding: 16px;
      }
      .sidebar.open{ transform: translateX(0); }

      .backdrop{
        display: block;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(2px);
        z-index: 55;
        opacity: 0;
        pointer-events: none;
        transition: opacity 220ms ease;
      }
      .backdrop.open{
        opacity: 1;
        pointer-events: auto;
      }
    }

    /* ============================================================
       CONFIG: COMPONENTES
       ============================================================ */
    .card{
      border: 1px solid var(--bd);
      border-radius: var(--radius);
      background: var(--glass);
      box-shadow: var(--shadow);
    }

    .cardHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--bd);
      background: color-mix(in srgb, var(--glass) 82%, transparent);
      backdrop-filter: blur(var(--blur));
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
    }

    .cardHeader h2{
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .cardHeader p{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .cardBody{ padding: 14px; }

    .divider{
      height: 1px;
      background: var(--bd);
      margin: 14px 0;
    }

    label{
      display: block;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, button, textarea{
      font: inherit;
      color: var(--text);
      border-radius: var(--radius-sm);
      border: 1px solid var(--bd2);
      background: color-mix(in srgb, var(--glass2) 72%, transparent);

      padding: 10px 10px;
      font-size: 13px;
      outline: none;
      min-width: 0;
    }

    input:focus, select:focus, textarea:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus) 60%, transparent);
      border-color: color-mix(in srgb, var(--aqua) 45%, var(--bd2));
    }

    .grid2{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .row{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Botones: flexibles, no se desbordan por texto */
    button{
      cursor: pointer;
      font-weight: 950;
      white-space: normal;
      line-height: 1.15;
    }

    .btn{
      background: var(--btn);
      border-color: var(--bd2);
    }
    .btn:hover{ background: var(--btnHover); }

    .btnPrimary{
      background: var(--primaryBg);
      border-color: var(--primaryBd);
    }
    .btnPrimary:hover{
      background: color-mix(in srgb, var(--primaryBg) 72%, var(--teal) 12%);
    }

    .btnDanger{
      background: var(--dangerBg);
      border-color: var(--dangerBd);
    }
    .btnDanger:hover{
      background: color-mix(in srgb, var(--dangerBg) 72%, var(--coral) 12%);
    }

    .btnWarn{
      background: var(--warnBg);
      border-color: var(--warnBd);
    }
    .btnWarn:hover{
      background: color-mix(in srgb, var(--warnBg) 70%, var(--cream) 14%);
    }

    .chipBtn{
      border-radius: 999px;
      padding: 10px 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .actionsGrid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    /* Listas */
    .list{ display: grid; gap: 10px; }

    .chip{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;

      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--bd2);
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
    }

    .chipInfo{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .chipInfo b{ font-size: 12px; letter-spacing: 0.2px; }
    .chipInfo span{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip button{
      white-space: nowrap;
      border-radius: 999px;
      padding: 8px 10px;
    }

    /* Tarjetas internas */
    .groupCard{
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--bd);
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
    }
    .groupCard h3{ margin: 0; font-size: 14px; }
    .groupMeta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Filas: horario */
    .scheduleRow{
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) auto;
      gap: 10px;
      align-items: end;

      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--bd);
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
    }

    .scheduleRow .removeBtn{
      white-space: nowrap;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
    }

    @media (max-width: 760px){
      .scheduleRow{ grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); }
      .scheduleRow .removeBtn{ grid-column: 1 / -1; width: 100%; }
    }
    @media (max-width: 460px){
      .scheduleRow{ grid-template-columns: 1fr; }
    }

    /* UI: filas de unidades */
    .unitRow{
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.7fr) auto;
      gap: 10px;
      align-items: end;

      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--bd);
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
    }

    .unitRow .removeBtn{
      white-space: nowrap;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
    }

    @media (max-width: 760px){
      .unitRow{ grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); }
      .unitRow .removeBtn{ grid-column: 1 / -1; width: 100%; }
    }
    @media (max-width: 460px){
      .unitRow{ grid-template-columns: 1fr; }
    }

    /* Reporte */
    .reportMeta{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .badges{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--aqua) 26%, var(--bd2));
      background: color-mix(in srgb, var(--aqua) 14%, var(--glass2) 70%);
      font-size: 12px;
      font-weight: 950;
    }

    .badgeWarn{
      border-color: color-mix(in srgb, var(--cream) 45%, var(--bd2));
      background: color-mix(in srgb, var(--cream) 16%, var(--glass2) 70%);
    }

    .badgeDanger{
      border-color: color-mix(in srgb, var(--coral) 40%, var(--bd2));
      background: color-mix(in srgb, var(--coral) 14%, var(--glass2) 70%);
    }

    .tableWrap{
      margin-top: 12px;
      max-height: 360px;
      overflow: auto;
      border-radius: var(--radius);
      border: 1px solid var(--bd);
      background: color-mix(in srgb, var(--glass2) 60%, transparent);
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--bd);
      vertical-align: top;
    }
    th{
      text-align: left;
      font-weight: 980;
      position: sticky;
      top: 0;
      background: color-mix(in srgb, var(--glass) 82%, transparent);
      backdrop-filter: blur(8px);
    }

    .subTitle{
      margin: 14px 0 0;
      font-size: 12px;
      font-weight: 980;
      color: color-mix(in srgb, var(--text) 88%, white 12%);
      letter-spacing: 0.2px;
    }
  </style>
</head>

<body>
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="brandTitle">
          <h1>Calculadora de sesiones</h1>
          <span class="tag">por grupo</span>
        </div>
        <p class="brandSub">Con exclusiones y PDF. Ahora incluye: ‚ÄúSe completa unidad‚Äù.</p>
      </div>

      <div class="actionsTop">
        <button id="menuBtn" class="btn chipBtn" type="button" title="Abrir configuraci√≥n (m√≥vil)">‚ò∞ Men√∫</button>
        <button id="themeBtn" class="btn chipBtn" type="button" title="Cambiar tema">üåô/‚òÄÔ∏è</button>
        <button id="quickCalcBtn" class="btn btnPrimary chipBtn" type="button" title="Calcular reporte">üßÆ Calcular</button>
        <button id="quickPdfBtn" class="btn btnPrimary chipBtn" type="button" title="Exportar PDF">üìÑ PDF</button>
      </div>
    </div>
  </header>

  <div class="app">
    <!-- =========================
         SIDEBAR
         ========================= -->
    <aside id="sidebar" class="sidebar card" aria-label="Configuraci√≥n">
      <div class="cardHeader">
        <h2>Configuraci√≥n</h2>
        <p>Rango, exclusiones, grupos, y plan de unidades (para saber cu√°ndo se completa cada unidad).</p>
      </div>

      <div class="cardBody">
        <!-- Rango del semestre -->
        <section aria-label="Rango del semestre">
          <label>Rango del semestre</label>
          <div class="grid2">
            <div>
              <label for="startDate">Inicio</label>
              <input id="startDate" type="date" />
            </div>
            <div>
              <label for="endDate">Fin</label>
              <input id="endDate" type="date" />
            </div>
          </div>
          <div class="hint">Captura el rango primero. Luego agrega festivos/vacaciones y grupos.</div>
        </section>

        <div class="divider"></div>

        <!-- Festivos -->
        <section aria-label="Festivos">
          <label>Festivos (fechas sueltas)</label>
          <div class="row">
            <input id="holidayDate" type="date" />
          </div>

          <div class="actionsGrid">
            <button id="addHolidayBtn" class="btn btnPrimary" type="button">Agregar festivo</button>
            <button id="clearHolidaysBtn" class="btn" type="button">Limpiar festivos</button>
          </div>

          <div id="holidaysList" class="list" style="margin-top:10px;"></div>
        </section>

        <div class="divider"></div>

        <!-- Vacaciones -->
        <section aria-label="Vacaciones">
          <label>Vacaciones (rangos)</label>
          <div class="grid2">
            <div>
              <label for="vacStart">Inicio</label>
              <input id="vacStart" type="date" />
            </div>
            <div>
              <label for="vacEnd">Fin</label>
              <input id="vacEnd" type="date" />
            </div>
          </div>

          <div class="actionsGrid">
            <button id="addVacationBtn" class="btn btnPrimary" type="button">Agregar vacaciones</button>
            <button id="clearVacationsBtn" class="btn" type="button">Limpiar vacaciones</button>
          </div>

          <div id="vacationsList" class="list" style="margin-top:10px;"></div>
        </section>

        <div class="divider"></div>

        <!-- Grupos -->
        <section aria-label="Grupos">
          <label>Agregar grupo</label>

          <div>
            <label for="groupName">Nombre del grupo</label>
            <input id="groupName" type="text" placeholder="Ej. 1022" style="width:100%;" />
          </div>

          <!-- Horario -->
          <div style="margin-top:12px;">
            <div class="row" style="justify-content: space-between;">
              <label style="margin:0;">Horario semanal</label>
              <button id="addScheduleRowBtn" class="btn btnPrimary" type="button">+ Agregar d√≠a</button>
            </div>

            <div id="scheduleRows" class="list" style="margin-top:10px;"></div>

            <div class="hint">Ejemplo: Lunes 2h, Martes 2h, Viernes 1h.</div>
          </div>

          <div class="divider"></div>

          <!-- =========================
               UI: UNIDADES (NUEVO)
               - Capturas las horas por unidad.
               - Con esto el reporte puede decir: ‚ÄúSe completa Unidad X‚Äù y si sobran/faltan horas.
               ========================= -->
          <div>
            <div class="row" style="justify-content: space-between;">
              <label style="margin:0;">Plan de unidades (opcional)</label>
              <button id="addUnitRowBtn" class="btn btnPrimary" type="button">+ Agregar unidad</button>
            </div>

            <div id="unitRows" class="list" style="margin-top:10px;"></div>

            <div class="hint">
              Captura las horas asignadas a cada unidad. El sistema calcular√° en qu√© fecha se completa cada una,
              y si sobran o faltan horas respecto al calendario real.
            </div>
          </div>

          <div class="actionsGrid">
            <button id="saveGroupBtn" class="btn btnPrimary" type="button">Guardar grupo</button>
            <button id="clearGroupsBtn" class="btn btnDanger" type="button">Eliminar todos</button>
          </div>

          <div class="divider"></div>

          <label>Grupos registrados</label>
          <div id="groupsList" class="list"></div>

          <div class="divider"></div>

          <div class="actionsGrid">
            <button id="calculateBtn" class="btn btnPrimary" type="button">Calcular reporte</button>
            <button id="exportPdfBtn" class="btn btnPrimary" type="button">Exportar PDF</button>
          </div>

          <div class="hint">El PDF se genera en el navegador con jsPDF + autoTable.</div>
        </section>
      </div>
    </aside>

    <!-- =========================
         MAIN: REPORTE
         ========================= -->
    <main class="card" aria-label="Reporte">
      <div class="cardHeader">
        <h2>Reporte</h2>
        <p id="reportMeta" class="reportMeta">A√∫n no calculado.</p>
      </div>

      <div class="cardBody">
        <div id="reportArea" class="list"></div>
      </div>
    </main>
  </div>

  <!-- Librer√≠as PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    /* ============================================================
       JS: Comentarios tipo ‚Äúmanual para editar‚Äù
       BLOQUES:
       1) Utilidad $
       2) Drawer m√≥vil y tema (üåô/‚òÄÔ∏è)
       3) Fechas (local, sin desfase UTC)
       4) Estado de la app
       5) Render de UI
       6) UI din√°mica: horarios y unidades
       7) Eventos
       8) CALCULO DE SESIONES
       9) CALCULO: UNIDADES ("Se completa Unidad X")
       10) Render del reporte
       11) Exportaci√≥n PDF (incluye unidades)
       ============================================================ */

    /* ============================================================
       1) Utilidad para seleccionar elementos por id
       ============================================================ */
    const $ = (id) => document.getElementById(id);

    /* ============================================================
       2) Drawer m√≥vil y tema
       ============================================================ */
    const sidebar = $("sidebar");
    const backdrop = $("backdrop");
    const menuBtn = $("menuBtn");

    function openDrawer(){
      sidebar.classList.add("open");
      backdrop.classList.add("open");
    }
    function closeDrawer(){
      sidebar.classList.remove("open");
      backdrop.classList.remove("open");
    }

    menuBtn.addEventListener("click", openDrawer);
    backdrop.addEventListener("click", closeDrawer);

    window.addEventListener("resize", () => {
      if (window.innerWidth > 980) closeDrawer();
    });

    const THEME_KEY = "semester_sessions_theme";
    const themeBtn = $("themeBtn");

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      themeBtn.textContent = (theme === "light") ? "‚òÄÔ∏è Claro" : "üåô Oscuro";
      localStorage.setItem(THEME_KEY, theme);
    }

    const savedTheme = localStorage.getItem(THEME_KEY);
    applyTheme(savedTheme === "light" ? "light" : "dark");

    themeBtn.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(current === "dark" ? "light" : "dark");
    });

    /* ============================================================
       3) Fechas (local)
       ============================================================ */
    const weekdayNames = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];

    function parseLocalDate(iso){
      if (!iso) return null;
      const [y, m, d] = iso.split("-").map(Number);
      return new Date(y, m - 1, d, 0, 0, 0, 0);
    }

    function formatISO(date){
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function addDays(date, n){
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + n);
      return d;
    }

    function inRange(date, start, end){
      const t = date.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    /* ============================================================
       4) Estado de la app
       ============================================================ */
    let groups = [];          // [{id, name, schedule:[{weekday,hours}], units:[{name,hours}]}]
    let holidays = new Set(); // Set("YYYY-MM-DD")
    let vacations = [];       // [{startISO,endISO}]
    let lastReport = null;    // cache del √∫ltimo reporte calculado (para PDF)

    /* ============================================================
       5) Render de UI
       ============================================================ */
    const holidaysListEl  = $("holidaysList");
    const vacationsListEl = $("vacationsList");
    const groupsListEl    = $("groupsList");

    const scheduleRowsEl  = $("scheduleRows");
    const unitRowsEl      = $("unitRows");

    const reportMetaEl = $("reportMeta");
    const reportAreaEl = $("reportArea");

    function renderHolidays(){
      holidaysListEl.innerHTML = "";
      const arr = Array.from(holidays).sort();

      if (arr.length === 0){
        holidaysListEl.innerHTML = `<div class="groupMeta">Sin festivos registrados.</div>`;
        return;
      }

      arr.forEach(iso => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `
          <div class="chipInfo">
            <b>Festivo</b>
            <span>${escapeHtml(iso)}</span>
          </div>
        `;

        const btn = document.createElement("button");
        btn.className = "btn btnDanger";
        btn.type = "button";
        btn.textContent = "Eliminar";
        btn.addEventListener("click", () => {
          holidays.delete(iso);
          renderHolidays();
        });

        chip.appendChild(btn);
        holidaysListEl.appendChild(chip);
      });
    }

    function renderVacations(){
      vacationsListEl.innerHTML = "";

      if (vacations.length === 0){
        vacationsListEl.innerHTML = `<div class="groupMeta">Sin vacaciones registradas.</div>`;
        return;
      }

      vacations
        .slice()
        .sort((a,b) => a.startISO.localeCompare(b.startISO))
        .forEach((v, idx) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `
            <div class="chipInfo">
              <b>Vacaciones</b>
              <span>${escapeHtml(v.startISO)} a ${escapeHtml(v.endISO)}</span>
            </div>
          `;

          const btn = document.createElement("button");
          btn.className = "btn btnDanger";
          btn.type = "button";
          btn.textContent = "Eliminar";
          btn.addEventListener("click", () => {
            vacations.splice(idx, 1);
            renderVacations();
          });

          chip.appendChild(btn);
          vacationsListEl.appendChild(chip);
        });
    }

    function renderGroups(){
      groupsListEl.innerHTML = "";

      if (groups.length === 0){
        groupsListEl.innerHTML = `<div class="groupMeta">A√∫n no hay grupos registrados.</div>`;
        return;
      }

      groups.forEach(g => {
        const card = document.createElement("div");
        card.className = "groupCard";

        const scheduleTxt = g.schedule
          .slice()
          .sort((a,b) => a.weekday - b.weekday)
          .map(s => `${weekdayNames[s.weekday]}: ${s.hours}h`)
          .join(" | ");

        // Resumen de unidades (si existen)
        const unitsCount = (g.units || []).length;
        const unitsHours = (g.units || []).reduce((acc, u) => acc + (Number(u.hours) || 0), 0);

        const unitsTxt = unitsCount
          ? `Unidades: ${unitsCount} (${fmtHours(unitsHours)} h)`
          : `Unidades: (sin plan)`;

        card.innerHTML = `
          <h3>${escapeHtml(g.name)}</h3>
          <div class="groupMeta">${escapeHtml(scheduleTxt)}</div>
          <div class="groupMeta">${escapeHtml(unitsTxt)}</div>
        `;

        const row = document.createElement("div");
        row.className = "row";
        row.style.marginTop = "10px";

        const del = document.createElement("button");
        del.className = "btn btnDanger";
        del.type = "button";
        del.textContent = "Eliminar";
        del.addEventListener("click", () => {
          groups = groups.filter(x => x.id !== g.id);
          renderGroups();
        });

        row.appendChild(del);
        card.appendChild(row);

        groupsListEl.appendChild(card);
      });
    }

    /* ============================================================
       6) UI din√°mica: Horarios y Unidades
       ============================================================ */

    // ---------- Horarios ----------
    function makeScheduleRow(weekday = 1, hours = 2){
      const row = document.createElement("div");
      row.className = "scheduleRow";

      const dayWrap = document.createElement("div");
      const dayLabel = document.createElement("label");
      dayLabel.textContent = "D√≠a";
      const daySelect = document.createElement("select");
      weekdayNames.forEach((name, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = name;
        daySelect.appendChild(opt);
      });
      daySelect.value = String(weekday);
      dayWrap.appendChild(dayLabel);
      dayWrap.appendChild(daySelect);

      const hoursWrap = document.createElement("div");
      const hoursLabel = document.createElement("label");
      hoursLabel.textContent = "Horas por sesi√≥n";
      const hoursInput = document.createElement("input");
      hoursInput.type = "number";
      hoursInput.min = "0.5";
      hoursInput.step = "0.5";
      hoursInput.value = String(hours);
      hoursWrap.appendChild(hoursLabel);
      hoursWrap.appendChild(hoursInput);

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btnDanger removeBtn";
      removeBtn.type = "button";
      removeBtn.textContent = "Quitar";
      removeBtn.addEventListener("click", () => row.remove());

      row.appendChild(dayWrap);
      row.appendChild(hoursWrap);
      row.appendChild(removeBtn);

      // M√©todo para leer valores (el guardado usa esto)
      row._getValue = () => ({
        weekday: Number(daySelect.value),
        hours: Number(hoursInput.value)
      });

      return row;
    }

    function addScheduleRow(weekday, hours){
      scheduleRowsEl.appendChild(makeScheduleRow(weekday, hours));
    }

    // ---------- Unidades (NUEVO) ----------
    function makeUnitRow(name = "", hours = 0){
      const row = document.createElement("div");
      row.className = "unitRow";

      const nameWrap = document.createElement("div");
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Unidad";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Ej. Unidad 1";
      nameInput.value = String(name || "");
      nameWrap.appendChild(nameLabel);
      nameWrap.appendChild(nameInput);

      const hoursWrap = document.createElement("div");
      const hoursLabel = document.createElement("label");
      hoursLabel.textContent = "Horas";
      const hoursInput = document.createElement("input");
      hoursInput.type = "number";
      hoursInput.min = "0.5";
      hoursInput.step = "0.5";
      hoursInput.value = (hours && Number(hours) > 0) ? String(hours) : "";
      hoursWrap.appendChild(hoursLabel);
      hoursWrap.appendChild(hoursInput);

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btnDanger removeBtn";
      removeBtn.type = "button";
      removeBtn.textContent = "Quitar";
      removeBtn.addEventListener("click", () => row.remove());

      row.appendChild(nameWrap);
      row.appendChild(hoursWrap);
      row.appendChild(removeBtn);

      // M√©todo para leer valores (el guardado usa esto)
      row._getValue = () => ({
        name: String(nameInput.value || "").trim(),
        hours: Number(hoursInput.value)
      });

      return row;
    }

    function addUnitRow(name, hours){
      unitRowsEl.appendChild(makeUnitRow(name, hours));
    }

    /* ============================================================
       7) Eventos
       ============================================================ */
    $("addHolidayBtn").addEventListener("click", () => {
      const iso = $("holidayDate").value;
      if (!iso) return;
      holidays.add(iso);
      $("holidayDate").value = "";
      renderHolidays();
    });

    $("clearHolidaysBtn").addEventListener("click", () => {
      holidays.clear();
      renderHolidays();
    });

    $("addVacationBtn").addEventListener("click", () => {
      const startISO = $("vacStart").value;
      const endISO   = $("vacEnd").value;
      if (!startISO || !endISO) return;

      const s = parseLocalDate(startISO);
      const e = parseLocalDate(endISO);
      if (!s || !e) return;

      const start = (s.getTime() <= e.getTime()) ? startISO : endISO;
      const end   = (s.getTime() <= e.getTime()) ? endISO   : startISO;

      vacations.push({ startISO: start, endISO: end });
      $("vacStart").value = "";
      $("vacEnd").value = "";
      renderVacations();
    });

    $("clearVacationsBtn").addEventListener("click", () => {
      vacations = [];
      renderVacations();
    });

    $("addScheduleRowBtn").addEventListener("click", () => addScheduleRow(5, 1));
    $("addUnitRowBtn").addEventListener("click", () => {
      // Sugerencia: auto-nombrar seg√∫n cu√°ntas ya hay (Unidad 1, 2, 3...)
      const next = unitRowsEl.children.length + 1;
      addUnitRow(`Unidad ${next}`, "");
    });

    $("saveGroupBtn").addEventListener("click", () => {
      const name = $("groupName").value.trim();
      if (!name) return;

      // --- Leer horario ---
      const schedRows = Array.from(scheduleRowsEl.children);
      const schedule = schedRows
        .map(r => (r._getValue ? r._getValue() : null))
        .filter(Boolean)
        .filter(s => Number.isFinite(s.hours) && s.hours > 0);

      if (schedule.length === 0) return;

      // --- Leer unidades (opcional) ---
      // Regla: solo guardamos unidades v√°lidas (horas > 0). Nombre vac√≠o se auto-ajusta luego.
      const unitRows = Array.from(unitRowsEl.children);
      let unitsRaw = unitRows
        .map(r => (r._getValue ? r._getValue() : null))
        .filter(Boolean);

      // Si hay filas pero todas vac√≠as o inv√°lidas, simplemente no se guardan
      unitsRaw = unitsRaw.filter(u => Number.isFinite(u.hours) && u.hours > 0);

      // Normalizamos nombres (si est√°n vac√≠os)
      const units = unitsRaw.map((u, i) => ({
        name: u.name ? u.name : `Unidad ${i + 1}`,
        hours: Number(u.hours)
      }));

      groups.push({
        id: cryptoRandomId(),
        name,
        schedule,
        units
      });

      // Reset del form (para capturar siguiente grupo)
      $("groupName").value = "";
      scheduleRowsEl.innerHTML = "";
      unitRowsEl.innerHTML = "";

      addScheduleRow(1, 2);
      addScheduleRow(2, 2);

      // Unidades: no forzamos filas por defecto; si quieres, descomenta:
      // addUnitRow("Unidad 1", 0);

      renderGroups();
    });

    $("clearGroupsBtn").addEventListener("click", () => {
      groups = [];
      renderGroups();
    });

    $("calculateBtn").addEventListener("click", () => renderReport(buildReport()));
    $("quickCalcBtn").addEventListener("click", () => { renderReport(buildReport()); closeDrawer(); });

    $("exportPdfBtn").addEventListener("click", exportPdf);
    $("quickPdfBtn").addEventListener("click", () => { exportPdf(); closeDrawer(); });

    /* ============================================================
       8) CALCULO DE SESIONES
       - Cuenta sesiones reales (rango - exclusiones) para cada grupo.
       ============================================================ */
    function isExcluded(date){
      const iso = formatISO(date);
      if (holidays.has(iso)) return true;

      for (const v of vacations){
        const s = parseLocalDate(v.startISO);
        const e = parseLocalDate(v.endISO);
        if (s && e && inRange(date, s, e)) return true;
      }
      return false;
    }

    function buildReport(){
      const start = parseLocalDate($("startDate").value);
      const end   = parseLocalDate($("endDate").value);

      if (!start || !end) return { error: "Falta capturar el rango del semestre (inicio y fin)." };
      if (start.getTime() > end.getTime()) return { error: "El inicio no puede ser posterior al fin." };
      if (groups.length === 0) return { error: "No hay grupos registrados." };

      const meta = {
        startISO: formatISO(start),
        endISO: formatISO(end),
        holidays: Array.from(holidays).sort(),
        vacations: vacations.slice()
      };

      const byGroup = [];
      let grandTotalHours = 0;

      for (const g of groups){
        // Consolidar horas por weekday (por si repites un d√≠a en el horario)
        const hoursByWeekday = new Map();
        for (const s of g.schedule){
          hoursByWeekday.set(s.weekday, (hoursByWeekday.get(s.weekday) || 0) + s.hours);
        }

        const sessions = [];
        let totalHours = 0;
        let cumulative = 0;

        // Recorremos cada fecha del rango
        for (let d = new Date(start.getTime()); d.getTime() <= end.getTime(); d = addDays(d, 1)){
          const wd = d.getDay();
          if (!hoursByWeekday.has(wd)) continue;
          if (isExcluded(d)) continue;

          const hours = hoursByWeekday.get(wd);
          cumulative += hours;
          totalHours += hours;

          sessions.push({
            iso: formatISO(d),
            weekday: weekdayNames[wd],
            hours,
            cumulativeHours: cumulative
          });
        }

        grandTotalHours += totalHours;

        // =========================================================
        // 9) CALCULO: UNIDADES ("Se completa Unidad X")  (NUEVO)
        // =========================================================
        const unitsPlan = (g.units || []).slice();
        const unitSummary = computeUnitCompletions(unitsPlan, sessions, totalHours);

        byGroup.push({
          group: g,
          sessions,
          totalHours,
          unitSummary
        });
      }

      return { meta, byGroup, grandTotalHours };
    }

    /* ============================================================
       9) CALCULO: UNIDADES ("Se completa Unidad X")
       - Entrada:
         unitsPlan: [{name,hours}] (puede venir vac√≠o)
         sessions:  [{iso,weekday,hours,cumulativeHours}]
         totalHours: n√∫mero
       - Salida:
         {
           requiredHours,
           diffHours,              // planned - required
           diffLabel,              // "Sobran" o "Faltan" o "Exacto"
           unitRows: [{
             name,
             unitHours,
             threshold,
             completed,           // boolean
             completedISO,        // fecha si se completa
             sessionHours,        // horas de esa sesi√≥n (si aplica)
             note                // texto docente-friendly
           }]
         }
       ============================================================ */
    function computeUnitCompletions(unitsPlan, sessions, totalHours){
      const cleanUnits = (unitsPlan || [])
        .filter(u => u && Number.isFinite(Number(u.hours)) && Number(u.hours) > 0)
        .map((u, i) => ({
          name: (String(u.name || "").trim()) || `Unidad ${i + 1}`,
          hours: Number(u.hours)
        }));

      const requiredHours = cleanUnits.reduce((acc, u) => acc + u.hours, 0);

      // Si no hay plan de unidades, regresamos estructura vac√≠a para UI
      if (cleanUnits.length === 0){
        return {
          hasPlan: false,
          requiredHours: 0,
          diffHours: 0,
          diffLabel: "Sin plan",
          unitRows: []
        };
      }

      // diffHours: positivo = sobran horas en calendario; negativo = faltan
      const diffHours = totalHours - requiredHours;
      const diffLabel =
        diffHours > 0 ? "Sobran" :
        diffHours < 0 ? "Faltan" :
        "Exacto";

      // Calculamos umbrales acumulados (U1, U1+U2, U1+U2+U3, ...)
      let threshold = 0;
      const unitRows = [];

      for (let i = 0; i < cleanUnits.length; i++){
        const u = cleanUnits[i];
        threshold += u.hours;

        // Buscamos la PRIMERA sesi√≥n donde el acumulado >= threshold
        const hit = sessions.find(s => s.cumulativeHours >= threshold);

        if (!hit){
          const missing = threshold - totalHours;
          unitRows.push({
            name: u.name,
            unitHours: u.hours,
            threshold,
            completed: false,
            completedISO: "",
            sessionHours: "",
            note: `No se completa (faltan ${fmtHours(missing)} h)`
          });
          continue;
        }

        // Queremos saber si se completa exacto o "a mitad de sesi√≥n"
        const priorCum = hit.cumulativeHours - hit.hours;
        const hoursIntoSession = threshold - priorCum; // cu√°nto de esa sesi√≥n se necesita para llegar al umbral
        const note = buildUnitNote(hoursIntoSession, hit.hours);

        unitRows.push({
          name: u.name,
          unitHours: u.hours,
          threshold,
          completed: true,
          completedISO: hit.iso,
          sessionHours: hit.hours,
          note
        });
      }

      return {
        hasPlan: true,
        requiredHours,
        diffHours,
        diffLabel,
        unitRows
      };
    }

    // Nota humanita: "al final de la sesi√≥n" o "a la hora X de Y"
    function buildUnitNote(hoursIntoSession, sessionHours){
      const x = fmtHours(hoursIntoSession);
      const y = fmtHours(sessionHours);

      // Por redondeos, tolerancia m√≠nima
      const eps = 1e-9;

      if (Math.abs(hoursIntoSession - sessionHours) < eps){
        return `Se completa al final de la sesi√≥n (${y} h)`;
      }
      // Si por alguna raz√≥n cayera muy cerca de 0, lo normalizamos a 0.5 m√≠nimo, etc.
      if (hoursIntoSession <= eps){
        return `Se completa al inicio de la sesi√≥n (${y} h)`;
      }
      return `Se completa durante la sesi√≥n: a la hora ${x} de ${y}`;
    }

    /* ============================================================
       10) Render del reporte (incluye unidades)
       ============================================================ */
    function renderReport(report){
      reportAreaEl.innerHTML = "";

      if (report.error){
        reportMetaEl.textContent = report.error;
        lastReport = null;
        return;
      }

      const { meta, byGroup, grandTotalHours } = report;

      reportMetaEl.textContent =
        `Semestre: ${meta.startISO} a ${meta.endISO} | Grupos: ${byGroup.length} | Total: ${fmtHours(grandTotalHours)} horas`;

      // Tarjeta: exclusiones
      const excl = document.createElement("div");
      excl.className = "groupCard";

      const holTxt = meta.holidays.length ? meta.holidays.join(" | ") : "Ninguno";
      const vacTxt = meta.vacations.length ? meta.vacations.map(v => `${v.startISO} a ${v.endISO}`).join(" | ") : "Ninguno";

      excl.innerHTML = `
        <h3>Exclusiones aplicadas</h3>
        <div class="groupMeta"><b>Festivos:</b> ${escapeHtml(holTxt)}</div>
        <div class="groupMeta"><b>Vacaciones:</b> ${escapeHtml(vacTxt)}</div>
      `;
      reportAreaEl.appendChild(excl);

      // Tarjeta por grupo
      for (const entry of byGroup){
        const g = entry.group;

        const scheduleTxt = g.schedule
          .slice()
          .sort((a,b) => a.weekday - b.weekday)
          .map(s => `${weekdayNames[s.weekday]}: ${s.hours}h`)
          .join(" | ");

        const card = document.createElement("div");
        card.className = "groupCard";

        card.innerHTML = `
          <h3>${escapeHtml(g.name)}</h3>
          <div class="groupMeta">Horario: ${escapeHtml(scheduleTxt)}</div>
          <div class="badges">
            <span class="badge">Sesiones: ${entry.sessions.length}</span>
            <span class="badge">Horas calendario: ${fmtHours(entry.totalHours)}</span>
          </div>
        `;

        // =========================
        // SECCI√ìN NUEVA: UNIDADES
        // =========================
        const us = entry.unitSummary;

        const unitsWrap = document.createElement("div");
        unitsWrap.style.marginTop = "10px";

        if (!us.hasPlan){
          const noPlan = document.createElement("div");
          noPlan.className = "groupMeta";
          noPlan.innerHTML = `<b>Unidades:</b> sin plan capturado para este grupo.`;
          unitsWrap.appendChild(noPlan);
        } else {
          // Encaje: sobran/faltan
          const required = us.requiredHours;
          const diff = us.diffHours;

          const badge = document.createElement("div");
          badge.className = "badges";

          // Etiqueta de encaje
          const bReq = document.createElement("span");
          bReq.className = "badge";
          bReq.textContent = `Horas por unidades: ${fmtHours(required)}`;

          const bDiff = document.createElement("span");
          const absDiff = Math.abs(diff);

          if (diff > 0){
            bDiff.className = "badge badgeWarn";
            bDiff.textContent = `Sobran ${fmtHours(absDiff)} h fuera del plan`;
          } else if (diff < 0){
            bDiff.className = "badge badgeDanger";
            bDiff.textContent = `Faltan ${fmtHours(absDiff)} h para completar unidades`;
          } else {
            bDiff.className = "badge";
            bDiff.textContent = `Encaja exacto (0 h fuera)`;
          }

          badge.appendChild(bReq);
          badge.appendChild(bDiff);

          const title = document.createElement("div");
          title.className = "subTitle";
          title.textContent = "Se completa Unidad X";

          unitsWrap.appendChild(badge);
          unitsWrap.appendChild(title);

          // Tabla de completado por unidad
          const uTableWrap = document.createElement("div");
          uTableWrap.className = "tableWrap";

          const uTable = document.createElement("table");
          uTable.innerHTML = `
            <thead>
              <tr>
                <th>Unidad</th>
                <th style="width:110px;">Horas</th>
                <th style="width:140px;">Se completa</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody>
              ${us.unitRows.map(r => `
                <tr>
                  <td>${escapeHtml(r.name)}</td>
                  <td>${escapeHtml(fmtHours(r.unitHours))}</td>
                  <td>${escapeHtml(r.completed ? r.completedISO : "No se completa")}</td>
                  <td>${escapeHtml(r.note)}</td>
                </tr>
              `).join("")}
            </tbody>
          `;
          uTableWrap.appendChild(uTable);
          unitsWrap.appendChild(uTableWrap);
        }

        card.appendChild(unitsWrap);

        // =========================
        // Sesiones (agregamos acumulado para que sea √∫til)
        // =========================
        const wrap = document.createElement("div");
        wrap.className = "tableWrap";

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:140px;">Fecha</th>
              <th>D√≠a</th>
              <th style="width:90px;">Horas</th>
              <th style="width:120px;">Acumulado</th>
            </tr>
          </thead>
          <tbody>
            ${entry.sessions.map(s => `
              <tr>
                <td>${escapeHtml(s.iso)}</td>
                <td>${escapeHtml(s.weekday)}</td>
                <td>${escapeHtml(fmtHours(s.hours))}</td>
                <td>${escapeHtml(fmtHours(s.cumulativeHours))}</td>
              </tr>
            `).join("")}
          </tbody>
        `;

        wrap.appendChild(table);
        card.appendChild(wrap);

        reportAreaEl.appendChild(card);
      }

      // Resumen final
      const summary = document.createElement("div");
      summary.className = "groupCard";
      summary.innerHTML = `
        <h3>Resumen general</h3>
        <div class="groupMeta">Total de horas programadas (todos los grupos): <b>${fmtHours(grandTotalHours)}</b></div>
      `;
      reportAreaEl.appendChild(summary);

      lastReport = report;
    }

    /* ============================================================
       11) Exportaci√≥n PDF (incluye "Se completa Unidad X")
       ============================================================ */
    function exportPdf(){
      const report = (lastReport && !lastReport.error) ? lastReport : buildReport();
      if (report.error){
        renderReport(report);
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      const marginX = 40;
      let y = 44;

      // Encabezado
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Reporte de sesiones por grupo", marginX, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Semestre: ${report.meta.startISO} a ${report.meta.endISO}`, marginX, y);
      y += 14;

      const hol = report.meta.holidays.length ? report.meta.holidays.join(", ") : "Ninguno";
      const vac = report.meta.vacations.length
        ? report.meta.vacations.map(v => `${v.startISO} a ${v.endISO}`).join(" | ")
        : "Ninguno";

      doc.text(`Festivos excluidos: ${hol}`, marginX, y); y += 14;
      doc.text(`Vacaciones excluidas: ${vac}`, marginX, y); y += 16;

      doc.text(`Total general de horas: ${fmtHours(report.grandTotalHours)}`, marginX, y);
      y += 18;

      // Resumen por grupo
      const summaryBody = report.byGroup.map(e => ([
        e.group.name,
        String(e.sessions.length),
        fmtHours(e.totalHours)
      ]));

      doc.autoTable({
        startY: y,
        head: [["Grupo","Sesiones","Horas calendario"]],
        body: summaryBody,
        styles: { font: "helvetica", fontSize: 10, cellPadding: 6 },
        headStyles: { fontStyle: "bold" },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 14;

      // Detalle por grupo
      for (const entry of report.byGroup){
        if (y > 700){ doc.addPage(); y = 44; }

        doc.setFont("helvetica", "bold");
        doc.setFontSize(13);
        doc.text(`Grupo: ${entry.group.name}`, marginX, y);
        y += 14;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);

        const scheduleTxt = entry.group.schedule
          .slice()
          .sort((a,b) => a.weekday - b.weekday)
          .map(s => `${weekdayNames[s.weekday]}: ${s.hours}h`)
          .join(" | ");

        doc.text(`Horario semanal: ${scheduleTxt}`, marginX, y); y += 12;
        doc.text(`Sesiones: ${entry.sessions.length} | Horas calendario: ${fmtHours(entry.totalHours)}`, marginX, y);
        y += 10;

        // ====== PDF: Unidades (si hay plan) ======
        const us = entry.unitSummary;

        if (us.hasPlan){
          const required = fmtHours(us.requiredHours);
          const diff = us.diffHours;
          const absDiff = fmtHours(Math.abs(diff));

          const encaje =
            diff > 0 ? `Sobran ${absDiff} h fuera del plan` :
            diff < 0 ? `Faltan ${absDiff} h para completar unidades` :
            `Encaja exacto (0 h fuera)`;

          doc.setFont("helvetica", "bold");
          doc.text("Se completa Unidad X", marginX, y);
          y += 12;

          doc.setFont("helvetica", "normal");
          doc.text(`Horas por unidades: ${required} | ${encaje}`, marginX, y);
          y += 8;

          const uBody = us.unitRows.map(r => ([
            r.name,
            fmtHours(r.unitHours),
            r.completed ? r.completedISO : "No se completa",
            r.note
          ]));

          doc.autoTable({
            startY: y + 6,
            head: [["Unidad","Horas","Se completa","Nota"]],
            body: uBody,
            styles: { font: "helvetica", fontSize: 9, cellPadding: 6 },
            headStyles: { fontStyle: "bold" },
            margin: { left: marginX, right: marginX },
            pageBreak: "auto"
          });

          y = doc.lastAutoTable.finalY + 14;
        } else {
          doc.text("Unidades: sin plan capturado para este grupo.", marginX, y);
          y += 14;
        }

        // ====== PDF: Sesiones (con acumulado) ======
        const sBody = entry.sessions.map(s => ([s.iso, s.weekday, fmtHours(s.hours), fmtHours(s.cumulativeHours)]));

        doc.autoTable({
          startY: y + 6,
          head: [["Fecha","D√≠a","Horas","Acumulado"]],
          body: sBody,
          styles: { font: "helvetica", fontSize: 9, cellPadding: 6 },
          headStyles: { fontStyle: "bold" },
          margin: { left: marginX, right: marginX },
          pageBreak: "auto"
        });

        y = doc.lastAutoTable.finalY + 18;
      }

      const filename = `reporte_sesiones_${report.meta.startISO}_a_${report.meta.endISO}.pdf`;
      doc.save(filename);
    }

    /* ============================================================
       Utilidades
       ============================================================ */
    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function cryptoRandomId(){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return `${a[0].toString(16)}${a[1].toString(16)}`;
    }

    // Formato de horas: 2 -> "2", 2.5 -> "2.5"
    function fmtHours(n){
      const x = Number(n) || 0;
      const s = x.toFixed(2).replace(/\.?0+$/,""); // quita ceros finales
      return s;
    }

    /* ============================================================
       INIT
       - A√±adimos filas de horario de ejemplo para que no empieces en blanco
       - Unidades las dejamos vac√≠as para que t√∫ decidas si usarlo
       ============================================================ */
    function init(){
      addScheduleRow(1, 2); // Lunes 2h
      addScheduleRow(2, 2); // Martes 2h

      renderHolidays();
      renderVacations();
      renderGroups();
    }

    init();
  </script>
</body>
</html>