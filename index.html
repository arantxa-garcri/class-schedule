<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador de Calendario de Clases</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow">
    <h1 class="text-3xl font-bold mb-6 text-center">Generador de Calendario de Clases</h1>

    <div class="space-y-6">
      <!-- Rango de fechas y festivos -->
      <section>
        <h2 class="text-xl font-semibold mb-2">1) Configuración del periodo</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block font-semibold">Fecha inicio</label>
            <input type="date" id="startDate" required class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block font-semibold">Fecha fin</label>
            <input type="date" id="endDate" required class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block font-semibold">Días festivos (YYYY-MM-DD, coma)</label>
            <input type="text" id="holidays" placeholder="2025-09-16, 2025-11-18" class="w-full border rounded px-3 py-2" />
            <p class="text-xs text-gray-500 mt-1">Se excluirán exactamente esas fechas.</p>
          </div>
        </div>
      </section>

      <!-- Grupos -->
      <section>
        <h2 class="text-xl font-semibold mb-2">2) Grupos y horarios</h2>
        <div id="groupsContainer" class="space-y-4"></div>
        <button type="button" id="addGroup" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded">+ Agregar grupo</button>
      </section>

      <!-- Acciones -->
      <section class="pt-4 border-t">
        <h2 class="text-xl font-semibold mb-3">3) Generar PDF</h2>
        <div class="flex flex-col md:flex-row gap-3">
          <button type="button" id="genPdfMatrix" class="flex-1 py-3 bg-green-600 text-white font-bold rounded">PDF: Tabla multi‑grupo</button>
          <button type="button" id="genPdfDetail" class="flex-1 py-3 bg-teal-600 text-white font-bold rounded">PDF: Detalle por grupo</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // --- Utilidades de fecha (local) ---
    const toISODate = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const da = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${da}`;
    };
    const parseLocalDate = (str) => {
      const m = /^\s*(\d{4})-(\d{2})-(\d{2})\s*$/.exec(str || '');
      if (!m) return null;
      return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]), 0, 0, 0, 0);
    };
    const days = ['domingo','lunes','martes','miércoles','jueves','viernes','sábado'];

    // --- UI dinámico de grupos ---
    const groupsContainer = document.getElementById('groupsContainer');
    document.getElementById('addGroup').addEventListener('click', () => addGroup());

    function addGroup(initial = {}) {
      const card = document.createElement('div');
      card.className = 'group-card border rounded-lg p-4 bg-gray-50';
      card.innerHTML = `
        <div class="flex items-start gap-3 justify-between">
          <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block font-semibold">Grupo</label>
              <input type="text" class="group-name w-full border rounded px-3 py-2" placeholder="Ej. 1022" value="${initial.group || ''}" />
            </div>
            <div>
              <label class="block font-semibold">Clase</label>
              <input type="text" class="class-name w-full border rounded px-3 py-2" placeholder="Ej. Matemáticas I" value="${initial.className || ''}" />
            </div>
          </div>
          <button type="button" class="remove-group text-red-600 text-sm">Eliminar</button>
        </div>
        <div class="mt-3">
          <label class="block font-semibold mb-2">Horario semanal</label>
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-200">
                <th class="border px-2 py-1">Día</th>
                <th class="border px-2 py-1">Horas</th>
                <th class="border px-2 py-1">Acción</th>
              </tr>
            </thead>
            <tbody class="sched-body"></tbody>
          </table>
          <button type="button" class="add-sched-row mt-2 px-3 py-1 bg-indigo-600 text-white rounded">+ Agregar día</button>
        </div>
      `;

      groupsContainer.appendChild(card);

      // Eventos del card
      card.querySelector('.remove-group').addEventListener('click', () => card.remove());
      const tbody = card.querySelector('.sched-body');
      const addRowBtn = card.querySelector('.add-sched-row');
      addRowBtn.addEventListener('click', () => addScheduleRow(tbody));

      // Fila inicial
      addScheduleRow(tbody);
    }

    function addScheduleRow(tbody) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-2 py-1">
          <select class="day-select w-full">
            ${days.map(d => `<option value="${d}">${d}</option>`).join('')}
          </select>
        </td>
        <td class="border px-2 py-1">
          <input type="number" class="hours-input w-full text-center" min="0" step="0.5" placeholder="2" />
        </td>
        <td class="border px-2 py-1 text-center">
          <button type="button" class="remove-row text-red-600">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('.remove-row').addEventListener('click', () => tr.remove());
    }

    // Crear al menos un grupo por defecto
    addGroup();

    // --- Recolección de datos ---
    function collectData() {
      const start = parseLocalDate(document.getElementById('startDate').value);
      const end = parseLocalDate(document.getElementById('endDate').value);
      if (!start || !end || start > end) {
        alert('Revisa fechas: inicio y fin en formato YYYY-MM-DD y que inicio ≤ fin.');
        return null;
      }
      const holidaySet = new Set();
      (document.getElementById('holidays').value || '').split(',').forEach(s => {
        const d = parseLocalDate(s);
        if (d) holidaySet.add(toISODate(d));
      });

      const groups = [];
      document.querySelectorAll('.group-card').forEach(card => {
        const group = card.querySelector('.group-name').value.trim();
        const className = card.querySelector('.class-name').value.trim();
        const schedule = [];
        card.querySelectorAll('.sched-body tr').forEach(tr => {
          const day = tr.querySelector('.day-select').value;
          const hrs = parseFloat(tr.querySelector('.hours-input').value) || 0;
          if (hrs > 0) schedule.push({ day, hrs });
        });
        if (group && className && schedule.length > 0) {
          groups.push({ group, className, schedule });
        }
      });

      if (groups.length === 0) {
        alert('Agrega al menos un grupo con horario.');
        return null;
      }

      // Generar lista de fechas (excluye festivos, incluye fin)
      const dates = [];
      for (let cur = new Date(start); cur <= end; cur.setDate(cur.getDate() + 1)) {
        if (!holidaySet.has(toISODate(cur))) {
          dates.push(new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()));
        }
      }

      return { start, end, holidaySet, groups, dates };
    }

    // --- Generación de PDF (detalle por grupo) ---
    document.getElementById('genPdfDetail').addEventListener('click', () => {
      const data = collectData();
      if (!data) return;
      const { start, end, holidaySet, groups } = data;

      // Decidir orientación si el nombre es largo (aquí dejamos portrait)
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'letter', orientation: 'portrait' });
      const margin = 40;

      groups.forEach((g, idx) => {
        if (idx > 0) doc.addPage();

        // Construir sesiones para ese grupo
        const sessions = [];
        for (let cur = new Date(start); cur <= end; cur.setDate(cur.getDate() + 1)) {
          const iso = toISODate(cur);
          if (holidaySet.has(iso)) continue;
          const dow = days[cur.getDay()];
          const totalHrsToday = g.schedule
            .filter(s => s.day === dow)
            .reduce((a, b) => a + b.hrs, 0);
          if (totalHrsToday > 0) {
            sessions.push({ date: new Date(cur.getFullYear(), cur.getMonth(), cur.getDate()), hrs: totalHrsToday });
          }
        }

        const totalSessions = sessions.length;
        const totalHours = sessions.reduce((sum, s) => sum + s.hrs, 0);

        doc.setFontSize(18);
        doc.text(`Calendario de Clases - Grupo ${g.group}`, margin, 60);
        doc.setFontSize(14);
        doc.text(`Asignatura: ${g.className}`, margin, 80);
        doc.text(`Clases totales: ${totalSessions}`, margin, 100);
        doc.text(`Horas totales: ${totalHours}`, margin + 250, 100);

        const rows = sessions.map((s, i) => [
          `#${String(i + 1).padStart(2, '0')}`,
          toISODate(s.date),
          s.hrs.toString(),
        ]);

        doc.autoTable({
          startY: 120,
          head: [['Sesión', 'Fecha', 'Horas']],
          body: rows,
          margin: { left: margin, right: margin },
          styles: { cellPadding: 6, fontSize: 12, halign: 'center', valign: 'middle' },
          headStyles: { fillColor: [220, 220, 220], textColor: 20, halign: 'center' },
          columnStyles: { 0: { halign: 'center' }, 1: { halign: 'center' }, 2: { halign: 'center' } },
        });

        const finalY = doc.lastAutoTable.finalY + 20;
        doc.setFontSize(12);
        doc.text(`Total horas efectivas: ${totalHours}`, margin, finalY);
      });

      doc.save('Calendario_por_grupo.pdf');
    });

    // --- Generación de PDF (tabla multi‑grupo) ---
    document.getElementById('genPdfMatrix').addEventListener('click', () => {
      const data = collectData();
      if (!data) return;
      const { dates, groups } = data;

      const orientation = groups.length > 4 ? 'landscape' : 'portrait';
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'letter', orientation });

      const margin = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const usableWidth = pageWidth - margin * 2;

      // Totales por grupo
      const totals = groups.map(g => {
        let sessions = 0, hours = 0;
        dates.forEach(d => {
          const dow = days[d.getDay()];
          const h = g.schedule.filter(s => s.day === dow).reduce((a,b) => a + b.hrs, 0);
          if (h > 0) { sessions += 1; hours += h; }
        });
        return { group: g.group, className: g.className, sessions, hours };
      });

      // Encabezado
      doc.setFontSize(18);
      doc.text('Calendario de Clases (multi‑grupo)', margin, 60);

      // Tabla de totales
      const totalsRows = totals.map(t => [t.group, t.className, String(t.sessions), String(t.hours)]);
      doc.autoTable({
        startY: 80,
        head: [['Grupo','Clase','Clases totales','Horas totales']],
        body: totalsRows,
        margin: { left: margin, right: margin },
        styles: { cellPadding: 6, fontSize: 12, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [220,220,220], textColor: 20, halign: 'center' }
      });

      // Matriz: filas = fechas, columnas = grupos
      const head = ['Fecha', ...groups.map(g => g.group)];

      const matrixRows = dates.map(d => {
        const row = [toISODate(d)];
        groups.forEach(g => {
          const dow = days[d.getDay()];
          const h = g.schedule.filter(s => s.day === dow).reduce((a,b) => a + b.hrs, 0);
          row.push(h > 0 ? String(h) : '');
        });
        return row;
      });

      // Column widths: fecha fija, resto distribuidas
      const dateColWidth = 110;
      const colWidth = (usableWidth - dateColWidth) / groups.length;
      const colStyles = { 0: { cellWidth: dateColWidth, halign: 'center' } };
      for (let i = 1; i <= groups.length; i++) colStyles[i] = { cellWidth: colWidth, halign: 'center' };

      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 20,
        head: [head],
        body: matrixRows,
        margin: { left: margin, right: margin },
        styles: { cellPadding: 6, fontSize: 11, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [220,220,220], textColor: 20, halign: 'center' },
        columnStyles: colStyles,
        tableWidth: 'auto'
      });

      doc.save('Calendario_multi_grupo.pdf');
    });
  </script>
</body>
</html>